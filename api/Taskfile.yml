# https://taskfile.dev

version: "3"

# Global variables
vars:
  APP_NAME: swipelearn-api
  VERSION: v1.0.0
  MAIN_PATH: cmd/server/main.go

  # Dynamic variables - calculated at runtime
  GIT_COMMIT:
    sh: git rev-parse HEAD 2>/dev/null || echo "unknown"
  BUILD_TIME:
    sh: date -u +"%Y-%m-%dT%H:%M:%SZ"
  GO_VERSION:
    sh: go version | awk '{print $3}'
  LD_FLAGS: "-X main.Version={{.VERSION}} -X main.GitCommit={{.GIT_COMMIT}} -X main.BuildTime={{.BUILD_TIME}}"

# Global environment variables
env:
  CGO_ENABLED: "0"

# Tasks
tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list-all | head -20

  # Development (Docker-focused)
  dev:
    desc: Start development environment with Docker Compose
    cmds:
      - echo "ğŸš€ Starting development environment..."
      - docker-compose -f ../docker-compose.dev.yml up -d
      - echo "âœ… Development environment started"
      - echo "ğŸ“Š View logs with docker-compose logs -f"
      - echo "ğŸ›‘ Stop with docker-compose down"

  dev-logs:
    desc: Follow development logs
    cmds:
      - docker-compose logs -f

  dev-stop:
    desc: Stop development environment
    cmds:
      - docker-compose down
      - echo "ğŸ›‘ Development environment stopped"

  dev-clean:
    desc: Stop and clean development environment (removes volumes)
    cmds:
      - docker-compose down -v
      - docker system prune -f
      - echo "ğŸ§¹ Development environment cleaned"

  # Local development (without Docker)
  local:
    desc: Run server locally (without Docker)
    cmds:
      - echo "ğŸƒ Running server locally..."
      - go run {{.MAIN_PATH}}

  local-hot:
    desc: Run locally with hot reload (air)
    cmds:
      - echo "ğŸ”¥ Running with hot reload..."
      - air -c .air.toml

  # Build tasks
  build:
    desc: Build application
    cmds:
      - echo "ğŸ”¨ Building {{.APP_NAME}}..."
      - go build -ldflags "{{.LD_FLAGS}}" -o bin/{{.APP_NAME}} {{.MAIN_PATH}}
      - echo "âœ… Build completed bin/{{.APP_NAME}}"

  build-prod:
    desc: Build for production
    cmds:
      - echo "ğŸš€ Building for production..."
      - go build -ldflags "{{.LD_FLAGS}}" -trimpath -o bin/{{.APP_NAME}} {{.MAIN_PATH}}
      - echo "âœ… Production build completed"

  # Testing
  test:
    desc: Run tests
    cmds:
      - echo "ğŸ§ª Running tests..."
      - go test -v ./...

  test-unit:
    desc: Run unit tests only
    cmds:
      - echo "ğŸ§ª Running unit tests..."
      - go test -v ./internal/services ./internal/repositories

  test-integration:
    desc: Run integration tests only
    cmds:
      - echo "ğŸ§ª Running integration tests..."
      - go test -v ./internal/handlers

  test-coverage:
    desc: Run tests with coverage
    cmds:
      - echo "ğŸ“Š Running tests with coverage..."
      - go test -v -coverprofile=bin/coverage.out ./...
      - go tool cover -html=bin/coverage.out -o bin/coverage.html
      - echo "ğŸ“„ Coverage report bin/coverage.html"

  test-unit-coverage:
    desc: Run unit tests with coverage
    cmds:
      - echo "ğŸ“Š Running unit tests with coverage..."
      - go test -v -coverprofile=bin/unit-coverage.out ./internal/services ./internal/repositories
      - go tool cover -html=bin/unit-coverage.out -o bin/unit-coverage.html
      - echo "ğŸ“„ Unit coverage report bin/unit-coverage.html"

  test-all-with-db:
    desc: Run all tests with database (requires PostgreSQL)
    cmds:
      - |
        echo "ğŸ§ª Running all tests with database..."
        DATABASE_URL="postgres://postgres:postgres@localhost:5432/testdb?sslmode=disable" go test -v ./...

  # Code quality
  fmt:
    desc: Format Go code
    cmds:
      - echo "ğŸ¨ Formatting code..."
      - go fmt ./...

  lint:
    desc: Run linter
    cmds:
      - echo "ğŸ” Running linter..."
      - golangci-lint run

  # Dependencies
  deps:
    desc: Update dependencies
    cmds:
      - echo "ğŸ“¦ Updating dependencies..."
      - go mod download
      - go mod tidy

  clean:
    desc: Clean build artifacts
    cmds:
      - echo "ğŸ§¹ Cleaning..."
      - rm -rf bin/
      - rm -rf tmp/
      - go clean

  # Version info
  version:
    desc: Show version info
    cmds:
      - echo "ğŸ“‹ {{.APP_NAME}} {{.VERSION}}"
      - echo "Git {{.GIT_COMMIT}}"
      - echo "Built {{.BUILD_TIME}}"
      - echo "Go {{.GO_VERSION}}"

  # Setup
  setup:
    desc: Initial setup for new developers
    cmds:
      - echo "ğŸ”§ Setting up SwipeLearn API..."
      - task: deps
      - task: test
      - echo "âœ… Setup complete! Run 'task dev' to start development"

  # Database migrations
  migrate-up:
    desc: Run database migrations up (local)
    cmds:
      - |
        set -a
        . ../.env
        set +a
        DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}?sslmode=disable"
        migrate -path migrations -database "$DATABASE_URL" up

  migrate-down:
    desc: Roll back last migration (local)
    cmds:
      - |
        set -a
        . ../.env
        set +a
        DATABASE_URL="postgres://${DB_USER}:${DB_PASSWORD}@localhost:${DB_PORT}/${DB_NAME}?sslmode=disable"
        migrate -path migrations -database "$DATABASE_URL" down 1
